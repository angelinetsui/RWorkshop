---
title: "Common R Syntax"
output: html_document
author: Yuan Chang Leong
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

I wanted to make explicit some of the common pattern structures of code that we've been using again and again in the class. I'll add to them as I think of more. For each, I'll first write in comments the "general syntax", and then an example of it. 

Click [here](https://htmlpreview.github.io/?https://github.com/nataliavelez/RWorkshop/blob/master/Resources/Common_R.html) to see knitted version of the file

### Loading libraries and installing packages

```{r}
# Installing packages: install.packages('<name of package>')
# install.packages('dplyr') # Commenting this out so that it will knit

# Load libraries: library(<name of library>)
library(dplyr)   
library(NHANES)  
library(ggplot2) 
```

### Manipulating the dataframe
This includes selecting columns, filtering rows, creating new variables. 

```{r}
# Try to always remember the same pattern
# <data.frame> = <data.frame> %>%
#   select(<columns to keep>) %>%
#   filter(<logical statement to determine which row to keep>) %>%
#   mutate(<new variable> = XXXX)

NHANES_adult = NHANES %>% 
  select(Age, Smoke100, Height) %>%
  filter(Age > 17 & !is.na(Smoke100) & !is.na(Height)) %>%
  mutate(HeightInInches = Height * 0.39)

head(NHANES_adult)
```


### Summarizing the dataframe
You do this when you want to aggregate (i.e. summarize) over certain variables. Again the syntax is usually near-identical.  

Another trick to remember - group_by is almost ALWAYS followed by summarise

```{r}
# <summary dataframe> = <full dataframe> %>%
#    group_by(<variable to group by>) %>%
#    summarise(<name of summary variable = <name of function>(<name of variable>))

# The common functions that go with summarize include, n() which counts, mean() which take the mean, var() which takes the variance, sd() which takes the sd:

data_summary = NHANES_adult %>%
  group_by(Smoke100) %>%
  summarise(n = n(), 
            meanHeight = mean(Height),
            varHeight = var(Height),
            sdHeight = sd(Height))

head(data_summary)
```

### Writing a function
```{r}
#<name of function> = function(<input1>, <input2>, ....){
# what you want the function to do
#}

sumOf2Numbers = function(x,y){
  z = x + y
  return(z)
}

thisSum = sumOf2Numbers(3,4)
thisSum
```
```{r}
# You can also set default values for the inputs:
sumOf2Numbers_wDefaults = function(x = 1 ,y = 2){
  z = x + y
  return(z)
}

# if you don't give it any inputs, the function will use the default values
thatSum = sumOf2Numbers_wDefaults()
thatSum
```
```{r}
# But you can overwrite the default
# The following line of code would add 4 to the default value of x.
anotherSum = sumOf2Numbers_wDefaults(y = 4)
anotherSum
```


## Statistical Tests   

### t-tests

We use the t-test to test if two means are statistically different (alternative = "two.tailed"). If we have a directional hypothesis (e.g., mean A > mean B or mean B < mean A), we can also specify it in our test (alternatve = "greater" or alternative = "less"). Later in the quarter, you'll learn that there are actually two types of tests - the two-sample t-test when you have two groups (this is the one you've been running so far), and the paired-sample t-test when you have paired data.  

```{r}
# Syntax of a t-test:
# <output name> = t.test(<Dependent Variable> ~ <Independent Variable>, data = <name of input data frame>, alternative = "XXX")

# First let's take a sample of 200 from NHANES_adult
set.seed(123456)
NHANES_sample = sample_n(NHANES_adult,200)

ttestResult = t.test(Height ~ Smoke100, data = NHANES_sample, alternative = "two.sided")
ttestResult
```
  
### Correlation
To measure the relationship between two <b>continuous</b> variables, we can calculate the correlation between them. In the slides, I used the function cor(), which calculates the correlation coefficient between the two variables. But cor() doesn't tell you if the correlation is statistically significant.  

For that, we can use use the function cor.test() which does a t-test on the r value to see if it's significantly different from 0.  

By default, these functions all run pearson's correlation. As you'll learn later in the quarter, there are actually different types of correlation (Kendall, Spearman) but Pearson is most commonly used. 


```{r}
# Syntax for cor: r = cor(<Variable1>, <Variable2>)
# Syntax for cor.test: r_sig = cor.test(<Variable1>, <Variable2>)

# Let's look at the correlation coefficient between Age and Height in NHANES_sample. Before computing the correlation, let's first visualize the relationship between the two:
ggplot(NHANES_sample, aes(x = Age, y = Height)) +
  geom_point() +
  geom_smooth(method = lm)

# Let's first use cor() to calculate the correlation coefficient
r = cor(NHANES_sample$Height, NHANES_sample$Age)
r

# Now we use cor.test()
r_sig = cor.test(NHANES_sample$Height, NHANES_sample$Age)
r_sig
```

### Randomization Test
We went over Randomization Test in Week 7's section, so I won't go over it again here. Briefly, the steps are as follows:  
1. Compute the statistic of interest (e.g., diffHeight from NHANES_sample)
2. Write a function that shuffles the labels, and recomputes the statistic of interest from the shuffled data
3. Run the function many times (~5000)
4. Compare the statistic of interest from the sample with the distribution obtained from running the function 5000 times.

```{r}
# Calculate diff Height from the sample
dataSummary = NHANES_sample %>% 
  group_by(Smoke100) %>%
  summarize(meanHeight=mean(Height))

diffHeight=diff(dataSummary$meanHeight)

# Write function that shuffles the labels
shuffleMeanNHANES = function(df){
  df = df %>% mutate(Smoke100shuffled = sample(Smoke100))
  
  means = df %>% 
    group_by(Smoke100shuffled) %>%
    summarize(mean=mean(Height)) 
  return(diff(means$mean))
}

# Run the function many times 
shuffleDist = replicate(5000,shuffleMeanNHANES(NHANES_sample))

# Compare original diffHeight to null distribution 
pValue = mean(shuffleDist>= diffHeight)
pValue

ggplot(data.frame(shuffleDist),aes(shuffleDist)) + 
  geom_histogram(bins=100) +
  geom_vline(xintercept = diffHeight,color='blue')
```


### Plotting
The syntax for ggplot is also usually very systematic as well:   
```{r}
# ggplot(<data.frame>, aes(<aesthetic mapping, which depends on plot type>)) +
#     geom_XXXX(<settings of the plot>)
```

Note that ggplot only takes in data.frames as inputs. If you have a vector, you have to convert it into a dataframe using data.frame() or as.data.frame().  

#### Histogram
```{r}
# Again, try to see if you fit the following format:
# ggplot(<data.frame>, aes(<aes mapping, which depends on plot type>)) +
#     geom_XXXX(<settings of the plot>)

# Histogram
ggplot(NHANES_adult, aes(Height)) +
  geom_histogram()

# what if you wanted to set the number of bins (how many bins there are)?
ggplot(NHANES_adult, aes(Height)) +
  geom_histogram(bins = 50)

# what if you wanted to set the bin width (how big is each bin)?
ggplot(NHANES_adult, aes(Height)) +
  geom_histogram(binwidth = 10)

# what if you wanted different colors of Smoke100
ggplot(NHANES_adult, aes(Height, fill = Smoke100)) +
  geom_histogram()

# The above plot will "stack" Smokers and Non-smokers on top of one another by default
# Instead, let's try to put them side by side
ggplot(NHANES_adult, aes(Height, fill = Smoke100)) +
  geom_histogram(position = 'dodge')

```

I'll try to add the following when I get a chance:  Line plots, Bar plots
